<!DOCTYPE html>
<html lang="en">
<!--JSON stringyfi JSON parse pour local storage garder le mot de passe et email en memoir-->
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Images Manager</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet"
            href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="css/site.css">
        <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
        <link rel="manifest" href="images/site.webmanifest">
        <link rel="icon" href="favicon.ico">
    </head>

    <body>

        <div class="mainContainer">
            <div class="headerPanel">
                <div class="headerLayout">
                    <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon"
                        title="Gestionnaire d'images">

                   <div style="display:flex">
                        <span class="header outLinedText tbg-yellow">
                            P
                        </span>
                        <span class="header outLinedText tbg-orange">
                            I
                        </span>
                        <span class="header outLinedText tbg-red">
                            C
                        </span>
                        <span class="header outLinedText tbg-pink ">
                            T
                        </span>
                        <span class="header outLinedText tbg-black">
                            -
                        </span>
                        <span class="header outLinedText tbg-purple">
                            C
                        </span>
                        <span class="header outLinedText tbg-blue">
                            L
                        </span>
                        <span class="header outLinedText tbg-green">
                            O
                        </span>
                        <span class="header outLinedText tbg-grass">
                            U
                        </span>
                        <span style="margin-right: 10px;" class="header outLinedText tbg-yellow">
                            D
                        </span>
                        <span class="cmd fa fa-plus-square iconsLeftUI" id="newImageCmd" title="Ajouter un image"
                        data-toggle="tooltip"></span>
                        <span id="sortDesc" class="cmd fa-solid fa-arrow-down-wide-short iconsLeftUI"></span>
                        <span id="sortAsc" class="cmd fa-solid fa-arrow-up-short-wide iconsLeftUI"></span>
                        <span id="afficherBarreRecherche" class="cmd fa fa-search iconsLeftUI" title="Afficher/masquer la barre de recherche"
                        data-toggle="tooltip"></span>
                    </div>
                </div>
                <div class="profilAndLogout">
                    <span></span>
                    <span class="cmd fas fa-sign-in-alt" id="connexionCmd" title="Se connecter"
                    data-toggle="tooltip"></span>
                    <span class="cmd fa fa-user-plus" id="inscriptionCmd" title="S'inscrire"
                    data-toggle="tooltip"></span>
                    <span class="cmd material-icons" id="verifiedUser" style="margin-top: -15%; font-size:36px; color: blue;">verified_user</span>
                    <img src="" id="avatar" class="avatar">
                    <span id="userName" class="userName"></span>
                    <span class="cmd fas fa-sign-out-alt" id="deconnexionCmd" title="Déconnexion" data-toggle="tooltip"></span>
                </div>
            </div>
            <div id="searchBar">
                <div class="searchBarLayout">
                    <select id="searchUser" class="form-control">
                        <option value="mes images">Mes images</option>
                        <!-- filled programmatically-->
                    </select>
                    <span> <!-- skip a column --> </span>
                    <input list="search_history" id="searchTitleDescription" class="form-control" placeholder="Recherche d'image" />
                    <datalist id="search_history"> 
                    
                    </datalist>
                    <span> <!-- skip a column --> </span>
                    <span id="searchCmd" class="cmd fa fa-search"></span>
                </div>
            </div>
            <div class="scrollContainer">
                <div id="imagesList">
                    <!-- filled programmatically-->
                </div>
            </div>
            
            <div>
                <div id="imageInfoDlg">
                    <form id="imageInfoForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="0">

                        <label for="title_info_input">Titre</label>
                        <input  id="title_info_input" class="form-control" readonly/>

                        <label for="description_info_input">Description</label>
                        <textarea id="description_info_input" class="form-control" readonly></textarea>

                        <label for="image_info">Image</label>
        
                        <a id="lienImage" href="" target="_blank">
                            <div    class='image2' id="image_info"
                                                        imageid=""  
                                                        style="background-image:url('${image.ThumbnailURL}')">
                                                        <!--<img src="" data-toggle="tooltip" title="" id="avatar_info" class="avatar">-->
                                                </div>
                            <div class="imageDate2"></div>
                        </a>
                        <br>
                        <label for="avatarCreateur">Créateur</label>
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <img src="" data-toggle="tooltip" title="" id="avatarCreateur"  class="avatarCreateur">
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <h3 id="nomCreateur_info"></h3>
                        </div>
                        

                    </form>
                </div>
                <div id="imageDlg">
                    <form id="imageForm">
                        <input type="hidden" id="Id_input" value="0">
                        <input type="hidden" id="date_input" value="0">
                        <input type="hidden" id="GUID_input" value="0">

                        <label for="title_input">Titre</label>
                        <input type="text" id="title_input" class="form-control" required>

                        <label for="description_input">Description</label>
                        <textarea id="description_input" class="form-control" required></textarea>

                        <label for="image">Image</label>
                        <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif'>
                        </div>
                        <label for="Shared_input">Partagé</label><input type="checkbox" name="Shared_input" id="Shared_input" class="checkbox">
                        <div class="note">Cliquez-Déposez une image</div>
                    </form>
                </div>
                <div id="inscriptionDlg">
                    <form id="inscriptionForm">
                        <input type="hidden" id="UserId_input" value="0">
                        <input type="hidden" id="AvatarGUID_input" value="0">

                        <label for="Name_input">Name</label>
                        <input type="text" id="Name_input" class="form-control" required>

                        <label for="Email_input">Email</label>
                        <input type="email" id="Email_input" class="form-control" required>
                        <label for="Password_input">Password</label>
                        <input type="password" id="Password_input" class="form-control">
                        <label for="ConfirmPassword_input">Confirm password</label>
                        <input type="password" id="ConfirmPassword_input" class="form-control">
                        <p id="ConfirmedPassword"></p>
                        <label for="imageUser" style="margin-top: 10px;">Avatar</label>
                        <div id='imageUser' class='ImageUploader' defaultImage='images/No_Image.png'
                            waitingImage='images/writing.gif' required>
                        </div>
                       
                    </form>
                </div>
                <div id="loginDlg">
                    <form id="loginForm">
                        
                        <label for="Email_input">Email</label>
                        <input type="text" id="EmailLogin_input" class="form-control Email" required>
                        <label for="Email_input">Password</label>
                        <input type="text" id="PasswordLogin_input" class="form-control Password" required>
                        <input type="checkbox" name="RememberMe_input" id="RememberMe_input" class="checkbox"><label for="RememberMe_input">Se souvenir de moi</label>
                        <br>
                        <p id="erreurLogin" class="erreur"></p>
                       
                       
                    </form>
                </div>
                <div id="confirmDeleteDlg">
                    <span id="confirmationMessage"></span>
                </div>
                <div id="confirmEmailDlg">
                    <form id="confirmEmailForm">
                        <input type="hidden" id="UserIdConfirm_input" value="0">
                        <span>Vérifier votre boîte de courriel pour un code de vérification</span>
                    <label for="code_input">Code de vérification</label>
                        <input type="text" id="code_input" class="form-control" required>
                    </form>
                    
                </div>
                <div id="errorDlg">
                    <span id="errorMessage"></span>
                </div>
                <div id="confirmLogOffDlg">
                    <span id="confirmLogOffText">Voulez-vous vraiment vous déconnecter ?</span>
                </div>
                <div id="confirmRemoveAccountDlg">
                    <span id="confirmRemoveAccountText">Voulez-vous vraiment effacer votre compte ?</span>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/api.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let selectedUser = "";
            let hideSearchBar = false;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let imagesCount = 50;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let verified = false;
            let loggedIn = false;
            let userId = 0;
            let keywordsTab = [];
            let sort = true

            init_UI();
            HEAD(CheckETag, error);
            setInterval(() => { HEAD(CheckETag, error) }, periodicRefreshPeriod * 1000);

            function CheckETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    GetImagesList();
                }
            }

            function GetImagesList(refresh = true) {
                appendMode = !refresh;
                function prepareQueryString() {
                    let queryString = "?sort=Date,desc";
                    if(!sort){
                        queryString = "?sort=Date,asc";
                    }
                    if (appendMode) {
                        queryString += `&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}`;
                        imagesCount += appendCount;
                    } else {
                        queryString += `&offset=${0}&limit=${imagesCount}`;
                    }

                    if(hideSearchBar) {
                        selectedUser = $("#searchUser").val();
                        let keywords = $("#searchTitleDescription").val();
                        if(selectedUser != ""){
                            if(selectedUser == "mes images"){
                                let user = RetrieveConnectedUser();
                                queryString += `&Userid=${user.Id}`;
                            }
                            else{
                                queryString += `&Userid=${selectedUser}`;
                            }
                            
                        }
                               
                        if(keywords != "") {
                            
                            queryString += `&keywords=${keywords.replaceAll(" ", ",").toLowerCase()}`;
                            let tabKeywords = (keywords.replaceAll(" ", ",").toLowerCase()).split(',');
                            UpdateDataListLocalStorage(tabKeywords);
                           // keywordsTab.add(keywords);
                            
                        }
                    }
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
                GET_ALL(refreshUsersList, error, "?sort=Username&fields=Userid,Username");
            }
            function UpdateDataListLocalStorage(data){
                let dataList = RetrieveDatalistLocalStorage();
                let newKeyword = false;
                if(dataList){
                    data.forEach(element => {
                        if(!dataList.includes(element)){
                          dataList.push(element);
                          newKeyword = true;
                        }
                      });
                      SetDatalistLocalStorage(dataList)
                      $("#search_history").empty();
                    dataList.forEach(data => {
                        $("#search_history").append($("<option>").attr('value' , data));
                    });
                }
                else{
                    SetDatalistLocalStorage(data);
                }
                  
                  
              
              }
            function changeSort(){
                sort = !sort;
                if(sort){
                    $("#sortDesc").hide();
                    $("#sortAsc").show();
                }
                else{
                    $("#sortDesc").show();
                    $("#sortAsc").hide();
                }
                GetImagesList();
            }
            function refreshUsersList(users) {
                $("#searchUser").empty();
                $("#searchUser").append("<option value=''>Toutes les utilisateurs</option>");
                for (let user of users) {
                    let userName = user.Username;
                    let userId = user.Userid;
                    let selected = (selectedUser == userName ? " selected " : "");
                    $("#searchUser").append(`<option value='${userId}' ${selected}>${userName}</option>`);
                }
            }

            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image) {
     
                    let user = RetrieveConnectedUser();
       // <a href="${image.OriginalURL}" target="_blank">
                    
                    if(user && user.Id == image.Userid){
                        if(image.Shared){
                        image.UserAvatarURL = "images/shared.png";
                        }
                        $("#imagesList").append(
                        $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                    </div>
                                   
                                        
                                        <div    class='image' 
                                                imageid="${image.Id}" 
                                                style="background-image:url('${image.ThumbnailURL}')">
                                                <img src="${image.UserAvatarURL}" data-toggle="tooltip" title=${image.Username} id="avatarImage${image.UserId}" class="avatar">
                                        </div>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                    
                    );
                    }
                    else{
                        if(image.Shared){
                            $("#imagesList").append(
                                $(` 
                                        <div class='imageLayout'>
                                            <div class='imageHeader'>
                                                <div class="imageTitle">${image.Title}</div>
                                            </div>
                                            
                                                
                                                <div    class='image'
                                                        imageid="${image.Id}"  
                                                        style="background-image:url('${image.ThumbnailURL}')">
                                                        <img src="${image.UserAvatarURL}" daaa-toggle="tooltip" title=${image.Username} id="avatarImage${image.UserId}" class="avatar">
                                                </div>
                                            </a>
                                            <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                        </div>
                                `));
                        }
                       
                    }
                    
                    
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {
                    insertIntoImageList(image);
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { Editimage(e) });
                $(".image").click(e=>{
                    OpenDialogImageInfo(e);
                })
                $(".deleteCmd").click(e => { Deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function NewImage() {
                holdCheckETag = true;
                createMode = true;
                ResetImageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }
            function Editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), ImageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }
            function Deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid")
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function ResetImageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("0");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                ImageUploader.resetImage('image');
            }
            function ImageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        Userid: JSON.parse(localStorage.getItem('connectedUser')).Id,
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        Shared: $('#Shared_input')[0].checked
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function ImageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                $("#date_input").val(image.Date);
                //$("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                ImageUploader.setImage('image', image.OriginalURL);
            }
            function ImageInfoToForm(image){
                console.log(convertToFrenchDate(parseInt(image.Date)));
                let date = convertToFrenchDate(parseInt(image.Date))
                $(".imageDate2").text(date);
                $("#title_info_input").val(image.Title);
                $("#description_info_input").val(image.Description);
                $("#image_info").attr('style' , `background-image:url('${image.ThumbnailURL}')`);
                //$("#avatar_info").attr('src' , image.UserAvatarURL);
                $("#nomCreateur_info").html(image.Username);
                $("#avatarCreateur").attr('src' , image.UserAvatarURL);
                $("#lienImage").attr('href', image.OriginalURL);
                
            }
            function Connection(){
                holdCheckETag = true;
                createMode = true;
                connectedUserRememberMe = RetrieveConnectedUserSession();
                $("#loginDlg").dialog('option', 'title', "connection");
                $("#loginDlgOkBtn").text("Connexion");
                if(connectedUserRememberMe != null){
                    $("#Email_input").text = connectedUserRememberMe.Email;
                    $("PasswordLogin_input").text = connectedUserRememberMe.Password;
                }
                $("#loginDlg").dialog('open');
            }
            function Inscription(){
                holdCheckETag = true;
                createMode = true;
                $("#desinscriptionDlgBtn").hide();
                $("#inscriptionDlg").dialog('option', 'title', "Inscription");
                $("#inscriptionDlgOkBtn").text("Inscription");
                $("#inscriptionDlg").dialog('open');
            }
            function Deconnexion(){
                holdCheckETag = true;
                createMode = true;
                $("#confirmLogOffDlg").dialog('option', 'title', "Déconnexion");
                $("#confirmLogOffDlg").dialog('open');
                
            }
            function LoginFromForm(){
                if ($("#loginForm")[0].checkValidity()) {
                    console.log("Bon")
                    let user = {
                        Email: $("#EmailLogin_input").val(),
                        Password: $("#PasswordLogin_input").val(),
                        Remember: $('#RememberMe_input')[0].checked
                    };
                    return user;
                } else {
                    console.log("Pas bon")
                    $("#loginForm")[0].reportValidity()
                }
                return false;
            }
            function InscriptionFromForm(){
                if ($("#inscriptionForm")[0].checkValidity()) {
                    let user = {
                        Id: parseInt($("#UserId_input").val()),
                        Name: $("#Name_input").val(),
                        Email: $("#Email_input").val(),
                        Password: $("#Password_input").val(),
                        AvatarGUID: $("#AvatarGUID_input").val(),
                        ImageData: ImageUploader.getImageData('imageUser'),
                        
                    };
                    return user;
                } else {
                    $("#inscriptionForm")[0].reportValidity()
                }
                return false;   
            }
            function VerifyPasswords() {
                let password = $("#Password_input").val();
                let confirmedPassword = $("#ConfirmPassword_input").val();
                if(password === confirmedPassword) {
                    $("#ConfirmedPassword").html("Passwords matching").css("color", "green");
                    return true;
                } else {
                    $("#ConfirmedPassword").html("Passwords don't match").css("color", "red");
                    return false;
                }
            }
            function UserConnected(token){
                verified = true;
                loggedIn = true;
                userId = token.UserId;
                $("userName").html(token.UserName);
                GET_USER(userId , AfficherAvatar , error);
                GetImagesList();
                
            }
            function OpenDialogVerifyCodeEmail(user){
                //ouvrir verify Dialog 
                holdCheckETag = true;
                createMode = true;
                $("#UserIdConfirm_input").val(user.Id);
                $("#confirmEmailDlg").dialog('option', 'title', "Verify");
                $("#confirmEmailDlgOkBtn").text("Verify Code");
                $("#confirmEmailDlg").dialog('open');
            }
            function UserVerified(){
                verified = true;
                $("#verifiedUser").show();
                Connection();
            }
            function GetConfirmCodeFromForm(){
                if ($("#confirmEmailForm")[0].checkValidity()) {
                    let user = {
                        Id: parseInt($("#UserIdConfirm_input").val()),
                        code: $("#code_input").val(),
                    };
                    return user;
                } else {
                    $("#inscriptionForm")[0].reportValidity()
                }
                return false;   
            }
            function Initialiser_UI_Login()
            {
                $("#connexionCmd").show();
                $("#inscriptionCmd").show();
                $("#avatar").hide();
                $("#newImageCmd").hide();
                $("#deconnexionCmd").hide();
                $("#userName").hide();
                $("#sortDesc").hide();
                $("#verifiedUser").hide();
                GetImagesList();
            }
            function AfficherAvatar(user){
                if(user.VerifyCode == "verified"){
                    //var userInfo = JSON.parse(window.localStorage.getItem('userConnected'));
                    $("#avatar").attr("src", user.AvatarURL).show();
                    $("#connexionCmd").hide();
                    $("#inscriptionCmd").hide();
                    $("#deconnexionCmd").show();
                    $("#newImageCmd").show();
                    $("#verifiedUser").show();
                    $("#userName").text(user.Name).show();
                }
                else{
                    OpenDialogVerifyCodeEmail(user);
                }
                GetImagesList();
                
            }
            function ModifyCallback(){
                GET_USER(RetrieveConnectedUser().Id ,  AfficherAvatar , error);
            }

            function ShowUserInfo(user) {
                $("#UserId_input").val(user.Id);
                $("#Name_input").val(user.Name);
                $("#Email_input").val(user.Email);
                //$("#Password_input").val(user.Password);
                ImageUploader.setImage('imageUser', user.AvatarURL)
                $("#AvatarGUID_input").val(user.AvatarGUID);
                
            }

            function ModifyUser() {
                let user = JSON.parse(localStorage.getItem('connectedUser'));
                $("#desinscriptionDlgBtn").show();
                ShowUserInfo(user);
                holdCheckETag = true;
                createMode = true;
                $("#inscriptionDlg").dialog('option', 'title', "Modification");
                $("#inscriptionDlgOkBtn").text("Modifier");
                $("#desinscriptionDlgBtn").text("Désinscrire");
                $("#inscriptionDlg").dialog('open');
            }

            function OpenDialogRemoveAccount() {
                holdCheckETag = true;
                createMode = true;
                $("#confirmRemoveAccountDlg").dialog('option', 'title', "Supression du compte");
                $("#confirmRemoveAccountDlg").dialog('open');
            }

            function RemoveAccountCallback() {
                $("#inscriptionDlg").dialog('close');
                $("#confirmRemoveAccountDlg").dialog('close');
                LogOutUser();
                Initialiser_UI_Login();
            }
            function OpenDialogImageInfo(e){
                holdCheckETag = true;
                GET_ID(e.target.getAttribute("imageid"), ImageInfoToForm, error);
                $("#imageInfoDlg").dialog('option', 'title', "Information");
                $("#imageInfoDlgOkBtn").text("Fermer");
                /// imageinfotoForm(image)
                $("#imageInfoDlg").dialog('open');
            }         
            function search(){
                appendMode= false;
                GetImagesList();
            }   
            function init_UI() {
                $("#newImageCmd").click(NewImage);
                $("#connexionCmd").click(Connection);
                $("#inscriptionCmd").click(Inscription);
                $("#deconnexionCmd").click(Deconnexion);
                $("#Password_input").blur(VerifyPasswords);
                $("#ConfirmPassword_input").blur(VerifyPasswords);
                $(".imageLayout").click(OpenDialogImageInfo);
                $("#userName").click(ModifyUser);
                $("#searchCmd").click(search);
                $("#sortDesc").click(changeSort);
                $("#sortAsc").click(changeSort);
                UpdateDataListLocalStorage(RetrieveDatalistLocalStorage());

                $("#afficherBarreRecherche").click(e => {
                    hideSearchBar = !hideSearchBar;
                    if (hideSearchBar)
                        $("#searchBar").slideDown('slow');
                    else
                        $("#searchBar").slideUp('slow');
                    GetImagesList();
                })

                //hide avatar and logout
                Initialiser_UI_Login();

                let user = RetrieveConnectedUser()
                if(user){
                    AfficherAvatar(user);
                }
                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = ImageFromForm();
                            if (image) {
                                if (createMode) {
                                    POST(image, GetImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else
                                    PUT(image, GetImagesList, error);
                                ResetImageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
                $("#imageInfoDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageInfoDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
                $("#loginDlg").dialog({
                    title: "Login",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "loginDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let user = LoginFromForm();
                            if(user){
                                LOGIN(user, UserConnected, error)
                                $(".scrollContainer").scrollTop(0);
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                            else 
                                $("erreurLogin").html("Un des champs n'est pas valide. Réessayer")
                            
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
                $("#inscriptionDlg").dialog({
                    title: "Inscription",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "desinscriptionDlgBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            OpenDialogRemoveAccount();
                        }
                    },
                    {
                        id: "inscriptionDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let user = InscriptionFromForm();
                            if(user && verified && VerifyPasswords()) {
                                MODIFY(user, ModifyCallback , error)
                                $(".scrollContainer").scrollTop(0);
                            }
                            if(user && !verified && VerifyPasswords() && user.Password != ""){
                                REGISTER(user, OpenDialogVerifyCodeEmail, error)
                                $(".scrollContainer").scrollTop(0);
   
                            }
                            if(VerifyPasswords()) {
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                            
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
                
                $("#confirmEmailDlg").dialog({
                    title: "Confirmation du email",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmEmailDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let user = GetConfirmCodeFromForm()
                            if(user){
                                VERIFY(user, UserVerified , error)
                                $(".scrollContainer").scrollTop(0);
   
                            }
                            holdCheckETag = false;
                            $(this).dialog("close");
                            
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                DELETE(imageIdToDelete, GetImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });
                $("#confirmLogOffDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id : "confirmLogOffBtnOk",
                        text: "confirm",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            let user = JSON.parse(window.localStorage.getItem("connectedUser"));
                            //pt mettre une fonction successcallback qui reset le client a cause du logout
                            LOGOUT(user.Id, Initialiser_UI_Login, error);
                            $(this).dialog("close");
                            
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });
                $("#confirmRemoveAccountDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id : "confirmRemoveAccountBtn",
                        text: "Retire mon compte",
                        click: function () {
                            let userId = JSON.parse(localStorage.getItem('connectedUser')).Id;
                            REMOVE(userId, RemoveAccountCallback , error);
                            $(".scrollContainer").scrollTop(0);
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });
                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        GetImagesList(false);
                    }
                });
            }
        </script>

    </body>

</html>